<!DOCTYPE html>
<html lang="en">
<head>
  <title>Rock Buddy</title>
</head>
<body>
  <div>
    <a href="../sniffer/sniffer.html">Sniffer</a> |
    <a href="../search/search.html">Search</a> |
    <a href="../account/account.html">Account</a>
    <a href="../config/config.html" style="float: right;">Config</a>
  </div>
  <h1>Leaderboard Sniffer</h1>
  <div id="loading">
    <p>Loading...</p>
  </div>
  <div id="error" style="display: none;">
  </div>
  <div id="waiting" style="display: none;">
    <p>Waiting for Rocksniffer...</p>
  </div>
  <div id="connected" style="display: none;">
    <div class="status">
      Sniffing...
    </div>
    <div class="data">

    </div>
  </div>
  <script src="../common/functions.js"></script>
  <script src="../../node_modules/jquery/dist/jquery.min.js"></script>
  <script>
    'use strict';
    sessionUpdate();

    const pollRate = 900;
    let requestActive = false;
    let currentSong = null;
    
    async function refresh() {
      if (requestActive) {
        console.warn('A request is already active, returning.');
        return;
      }

      requestActive = true;

      const rocksnifferData = await getRocksnifferData();

      if (rocksnifferData['success']) {

        // If we are switching songs, perform a sync
        if (rocksnifferData['songDetails']['songID'] !== currentSong) {
          currentSong = rocksnifferData['songDetails']['songID'];
          await syncData(rocksnifferData);
        }
        
        displayData(rocksnifferData);
      }
      else {
        $('div.status').html('Navigate to a song in Rocksmith...');
      }

      requestActive = false;
    }

    async function displayData(rocksnifferData) {

    }

    async function syncData(rocksnifferData) {
      $('div.status').html('Syncing data...');
      const rocksmithData = await getRocksmithProfileData();
      
      $('div.status').html('Sniffing...');
    }

    async function checkForNewRocksmithProfileData() {
      const steamUserDataPath = sessionStorage.getItem('steam_user_data_path');
      const steamProfile = sessionStorage.getItem('steam_profile');
      const rocksmithProfile = sessionStorage.getItem('rocksmith_profile');

      return await api.checkForNewRocksmithProfileData(steamUserDataPath, steamProfile, rocksmithProfile);
    }

    async function getRocksmithProfileData() {
      const steamUserDataPath = sessionStorage.getItem('steam_user_data_path');
      const steamProfile = sessionStorage.getItem('steam_profile');
      const rocksmithProfile = sessionStorage.getItem('rocksmith_profile');

      return await api.getRocksmithProfileData(steamUserDataPath, steamProfile, rocksmithProfile);
    }

    async function getRocksnifferData() {
      const rocksnifferHost = sessionStorage.getItem('rocksniffer_host');
      const rocksnifferPort = sessionStorage.getItem('rocksniffer_port');

      //JSON query the addon service
      try {
        const response = await $.get("http://"+rocksnifferHost+":"+rocksnifferPort);
        showComponent('connected');

        let randomNumber = Math.floor(Math.random() * 69) + 1;
        if (randomNumber === 69) {
          console.log('*sniff sniff*');
        }

        return response;
      } catch (error) {
        showComponent('waiting');
        return null;
      }
    }

    async function showComponent(component) {
      const components = {
        loading: document.getElementById('loading'),
        error: document.getElementById('error'),
        waiting: document.getElementById('waiting'),
        connected: document.getElementById('connected')
      };

      const componentsKeys = Object.keys(components);
      componentsKeys.forEach((c) => {
        if (component === c) {
          components[c].style.display = 'block';
        }
        else {
          components[c].style.display = 'none';
        }
      });
    }

    async function connectToRocksmith() {
      let steamUserDataPath = sessionStorage.getItem('steam_user_data_path');
      let steamProfile = sessionStorage.getItem('steam_profile');
      let rocksmithProfile = sessionStorage.getItem('rocksmith_profile');

      if (steamUserDataPath === null || steamProfile === null || rocksmithProfile === null) {
        steamUserDataPath = await api.storeGet('steam_user_data_path');
        steamProfile = await api.storeGet('steam_profile');
        rocksmithProfile = await api.storeGet('rocksmith_profile');

        if (steamUserDataPath === null || steamProfile === null || rocksmithProfile === null) {
          document.getElementById('error').innerHTML = '<p>Could not find Rocksmith user data. Check that your config settings are correct.</p>';
          showComponent('error');
          return false;
        }

        sessionStorage.setItem('steam_user_data_path', steamUserDataPath);
        sessionStorage.setItem('steam_profile', steamProfile);
        sessionStorage.setItem('rocksmith_profile', rocksmithProfile);
      }

      return true;
    }

    async function connectToRocksniffer() {
      const rocksnifferHost = sessionStorage.getItem('rocksniffer_host');
      const rocksnifferPort = sessionStorage.getItem('rocksniffer_port');

      // If we don't have the host and port, get it
      if (rocksnifferHost === null || rocksnifferPort === null) {
        const rocksnifferPath = await api.storeGet('rocksniffer_path');
        if (rocksnifferPath === null) {
          document.getElementById('error').innerHTML = '<p>Could not find Rocksniffer. Check that your config settings are correct.</p>';
          showComponent('error');
          return false;
        }

        const addonConfigFile = await api.pathJoin(rocksnifferPath, 'config', 'addons.json');
        const addonConfig = JSON.parse(await api.readFile(addonConfigFile));

        // Make sure addons are enabled
        if (!addonConfig['enableAddons']) {
          console.log('Enabling Rocksniffer addons.');
          addonConfig['enableAddons'] = true;
          await api.writeFile(addonConfigFile, JSON.stringify(addonConfig, null, 2));
        }

        sessionStorage.setItem('rocksniffer_host', addonConfig['ipAddress']);
        sessionStorage.setItem('rocksniffer_port', addonConfig['port']);
      }

      return true;
    }

    async function main() {
      const rocksmithConnected = await connectToRocksmith();
      const rocksnifferConnected = await connectToRocksniffer();

      if (rocksmithConnected && rocksnifferConnected) {
        setInterval(refresh, pollRate);
        refresh();
      }
    }

    main();
  </script>
</body>
</html>