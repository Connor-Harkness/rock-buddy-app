<!DOCTYPE html>
<html lang="en">
<head>
  <title>Rocksmith Leaderboards</title>
</head>
<body>
  <div class="auth-required" style="display: none;">
    <div>
      <a href="../sniffer/sniffer.html">Sniffer</a> |
      <a href="../search/search.html">Search</a> |
      <a href="../account/account.html">Account</a>
    </div>
    <h1>Leaderboard Sniffer</h1>
    <p>Waiting for RockSniffer...</p>
  </div>
  <div class="loading">Loading...</div>
  <script src="../common/functions.js"></script>
  <script>
    async function authenticate(authData) {
      const host = await api.getHost();
      const response = await post(host + '/api/auth/authenticate.php', authData);

      if ('error' in response) {
        console.error(response['error']);
        return false;
      }

      if (response['success']) {
        // User has been authenticated, set the auth data for the active session
        sessionStorage.setItem('auth_data', JSON.stringify(authData));
      }

      return response['success'];
    }

    async function main() {
      // If a session is already active, we don't need to reauthenticate
      if (sessionStorage.getItem('auth_data') === null) {

        // Get stored authentication data
        const authData = await api.getAuthData();
        if (authData === null) {
          // No auth data found - redirect to login
          window.location.href = '../auth/login.html';
          return;
        }

        // Authenticate
        const authStatus = await authenticate(authData);
        if (!authStatus) {
          // Authentication failed - redirect to login
          window.location.href = '../auth/login.html';
          return;
        }
      }

      // Get the user from the active session
      const authData = JSON.parse(sessionStorage.getItem('auth_data'));

      // Verify the user's email
      const verified = await checkEmailVerification(authData['user_id']);
      if (!verified) {
        // Verification failed - redirect to email_not_verified
        window.location.href = '../auth/email_not_verified.html'
        return; 
      }

      // If we made it this far it is safe to display the page
      document.querySelector('.loading').style.display = 'none';
      document.querySelector('.auth-required').style.display = 'block';
    }

    main();
  </script>
</body>
</html>