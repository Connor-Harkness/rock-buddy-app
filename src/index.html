<!DOCTYPE html>
<html lang="en">
<head>
  <title>Rocksmith Leaderboards</title>
</head>
<body>
  <h1 id="message">Hello, world!</h1>
  <script src="auth/email_verification.js"></script>
  <script>
    async function authenticate(authData) {
      const host = await api.getHost();
      try {
        const response = await fetch(host + '/api/auth/authenticate.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(authData)
        });

        if (response.ok) {
          // Authentication successful
          sessionStorage.setItem('user_id', authData['user_id']);
          return true;
        }
        else {
          // Authentication failed
          const data = await response.json();
          api.error(data['error']);
          return false;
        }
      } catch (error) {
        api.error(error.toString());
        return false;
      }
    }

    async function main() {
      const authData = await api.getAuthData();
      if (authData === null) {
        // No auth data found - redirect to login
        window.location.href = 'auth/login.html';
        return;
      }

      // Authenticate
      const authStatus = await authenticate(authData);
      if (!authStatus) {
        // Authentication failed - redirect to login
        window.location.href = 'auth/login.html';
        return;
      }

      // Check email verification
      const userId = sessionStorage.getItem('user_id')
      const verified = await checkEmailVerification(userId);
      if (!verified) {
        // Verification failed - redirect to email_not_verified
        window.location.href = 'auth/email_not_verified.html'
        return; 
      }
    }

    main();
  </script>
</body>
</html>