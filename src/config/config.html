<!DOCTYPE html>
<html lang="en">
<head>
  <title>Rock Buddy</title>
</head>
<body>
  <div>
    <a href="../sniffer/sniffer.html">Sniffer</a> |
    <a href="../search/search.html">Search</a> |
    <a href="../account/account.html">Account</a>
    <a href="../config/config.html" style="float: right;">Config</a>
  </div>

  <h1>Config</h1>
  
  <h2>Steam User Data Path</h2>
  <div id="steam_user_data_path" style="display: inline;"> </div>
  <div style="display: inline; float: right;">
    <button onclick="getSteamUserDataPath()">Browse</button>
  </div>
  <hr>
  <h2>Steam Profile</h2>
  <select id="steam_profile">
  </select>
  <hr>
  <h2>Rocksmith Profile</h2>
  <select id="rocksmith_profile">
    <option value="1" selected>[None]</option>
  </select>
  <hr>

  <script src="../common/functions.js"></script>
  <script>
    'use strict';
    sessionUpdate();

    async function getSteamUserDataPath() {
      const defaultPath = document.getElementById('steam_user_data_path').innerText;

      const steamUserDataPath = await api.getPath(defaultPath);
      if (steamUserDataPath !== null) {
        document.getElementById('steam_user_data_path').innerText = steamUserDataPath;
        api.storeSet('steam_user_data_path', steamUserDataPath);
      }
    }

    async function getSteamProfiles() {
      const steamUserDataPath = document.getElementById('steam_user_data_path').innerText;

      // Get all steam profiles on disk
      const steamProfiles = await api.getSteamProfiles(steamUserDataPath);
      const profileNames = Object.keys(steamProfiles);

      // If a profile is already saved, remember it
      let selectedProfile = await api.storeGet('steam_profile');
      if (profileNames.length === 1) {
        selectedProfile = steamProfiles[profileNames[0]];
        api.storeSet('steam_profile', selectedProfile);
      }

      // Build the combo box
      const comboBox = document.querySelector('#steam_profile');
      profileNames.forEach((profileName) => {
        const option = document.createElement('option');
        option.text = profileName;
        option.value = steamProfiles[profileName];
        
        // Set the selected profile to the saved profile if there is one
        if (steamProfiles[profileName] === selectedProfile) {
          option.selected = true;
        }

        comboBox.appendChild(option);
      });

      // Link the combo box selected option to the saved steam profile
      comboBox.addEventListener("change", () => {
        const selectedOption = comboBox.options[comboBox.selectedIndex];
        const selectedProfile = selectedOption.value;
        api.storeSet('steam_profile', selectedProfile);
      });
    }

    async function getRocksmithProfiles() {
      const steamUserDataPath = document.getElementById('steam_user_data_path').innerText;
    

      const rocksmithProfile = await api.storeGet('rocksmith_profile');
      if (rocksmithProfile !== null) {
        // set combo box to stored value
      }
    }

    async function main() {
      const steamUserDataPath = await api.storeGet('steam_user_data_path');
      if (steamUserDataPath !== null) {
        document.getElementById('steam_user_data_path').innerText = steamUserDataPath;
      }

      // Populate the combo boxes with available data
      await getSteamProfiles();

      await getRocksmithProfiles();
    }

    main();
  </script>
</body>