<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="../css/footer.css">
  <title>Rock Buddy (alpha test)</title>
</head>
<body>
  <div>
    <a href="../sniffer/sniffer.html">Sniffer</a> |
    <a href="../search/search.html">Search</a> |
    <a href="../account/account.html">Account</a>
    <a href="../config/config.html" style="float: right;">Config</a>
  </div>

  <h1>Config</h1>
  
  <h2>Steam User Data Path</h2>
  <div id="steam_user_data_path" style="display: inline;">[none selected]</div>
  <div style="display: inline; float: right;">
    <button onclick="getSteamUserDataPath()">Browse</button>
  </div>
  <hr>
  <h2>Steam Profile</h2>
  <select id="steam_profile">
  </select>
  <hr>
  <h2>Rocksmith Profile</h2>
  <select id="rocksmith_profile">
  </select>
  <hr>
  <h2>Rocksniffer Path</h2>
  <div id="rocksniffer_path" style="display: inline;">[none selected]</div>
  <div style="display: inline; float: right;">
    <button onclick="getRocksnifferPath()">Browse</button>
  </div>
  <hr>
  <footer>
    <p>
      Copyright &copy; 2023, All Rights Reserved <a href="mailto:tntmusicstudios2018@gmail.com">TNTMusicStudios</a>
    </p>
  </footer>
  <script src="../common/functions.js"></script>
  <script>
    'use strict';
    sessionUpdate();

    const userId = JSON.parse(sessionStorage.getItem('auth_data'))['user_id'];

    async function getSteamUserDataPath() {
      const defaultPath = document.getElementById('steam_user_data_path').innerText;

      const steamUserDataPath = await api.getPath(defaultPath);
      if (steamUserDataPath !== null) {
        document.getElementById('steam_user_data_path').innerText = steamUserDataPath;
        await api.storeSet('user_data.' + userId + '.steam_user_data_path', steamUserDataPath);
        sessionStorage.setItem('steam_user_data_path', steamUserDataPath);
      }

      // Recall the main function to populate the rest of the display
      main();
    }

    async function getSteamProfiles() {
      const steamUserDataPath = document.getElementById('steam_user_data_path').innerText;

      // Get all Steam profiles on disk
      const steamProfiles = await api.getSteamProfiles(steamUserDataPath);
      const profileNames = Object.keys(steamProfiles);

      // If a profile is already saved, remember it
      let selectedProfile = await api.storeGet('user_data.' + userId + '.steam_profile');
      if (profileNames.length !== 0 && selectedProfile === null) {
        selectedProfile = steamProfiles[profileNames[0]];
        await api.storeSet('user_data.' + userId + '.steam_profile', selectedProfile);
        sessionStorage.setItem('steam_profile', selectedProfile);
      }

      // Build the combo box
      const comboBox = document.querySelector('#steam_profile');
      profileNames.forEach((profileName) => {
        const option = document.createElement('option');
        option.text = profileName;
        option.value = steamProfiles[profileName];
        
        // Set the selected profile to the saved profile if there is one
        if (steamProfiles[profileName] === selectedProfile) {
          option.selected = true;
        }

        comboBox.appendChild(option);
      });

      // Link the combo box selected option to the saved Steam profile
      comboBox.addEventListener('change', async () => {
        const selectedOption = comboBox.options[comboBox.selectedIndex];
        const selectedProfile = selectedOption.value;
        await api.storeSet('user_data.' + userId + '.steam_profile', selectedProfile);
        sessionStorage.setItem('steam_profile', selectedProfile);
      });
    }

    async function getRocksmithProfiles() {
      const steamUserDataPath = document.getElementById('steam_user_data_path').innerText;
      const steamProfile = await api.storeGet('user_data.' + userId + '.steam_profile');

      // Get all Rocksmith profiles on disk
      const rocksmithProfiles = await api.getRocksmithProfiles(steamUserDataPath, steamProfile);
      const profileNames = Object.keys(rocksmithProfiles);

      // If a profile is already saved, remember it
      let selectedProfile = await api.storeGet('user_data.' + userId + '.rocksmith_profile');
      if (profileNames.length !== 0 && selectedProfile === null) {
        selectedProfile = rocksmithProfiles[profileNames[0]];
        await api.storeSet('user_data.' + userId + '.rocksmith_profile', selectedProfile);
        sessionStorage.setItem('rocksmith_profile', selectedProfile);
      }

      // Build the combo box
      const comboBox = document.querySelector('#rocksmith_profile');
      profileNames.forEach((profileName) => {
        const option = document.createElement('option');
        option.text = profileName;
        option.value = rocksmithProfiles[profileName];
        
        // Set the selected profile to the saved profile if there is one
        if (rocksmithProfiles[profileName] === selectedProfile) {
          option.selected = true;
        }

        comboBox.appendChild(option);
      });

      // Link the combo box selected option to the saved Rocksmith profile
      comboBox.addEventListener('change', async () => {
        const selectedOption = comboBox.options[comboBox.selectedIndex];
        const selectedProfile = selectedOption.value;
        await api.storeSet('user_data.' + userId + '.rocksmith_profile', selectedProfile);
        sessionStorage.setItem('rocksmith_profile', selectedProfile);
      });
    }

    async function getRocksnifferPath() {
      const rocksnifferPath = await api.getPath();
      if (rocksnifferPath !== null) {
        document.getElementById('rocksniffer_path').innerText = rocksnifferPath;
        api.storeSet('user_data.' + userId + '.rocksniffer_path', rocksnifferPath);
        sessionStorage.setItem('rocksniffer_path', rocksnifferPath);
      }
    }

    async function main() {
      // Populate Steam user data path if there is a default set
      let steamUserDataPath = await api.storeGet('user_data.' + userId + '.steam_user_data_path');
      if (steamUserDataPath === null) {
        steamUserDataPath = await api.storeGet('default_steam_user_data_path');
        api.storeSet('user_data.' + userId + '.steam_user_data_path', steamUserDataPath);
      }
      if (steamUserDataPath !== null) {
        document.getElementById('steam_user_data_path').innerText = steamUserDataPath;
        sessionStorage.setItem('steam_user_data_path', steamUserDataPath);
      }

      // Populate the combo box for Steam profiles
      await getSteamProfiles();

      // Populate the combo box for Rocksmith profiles
      await getRocksmithProfiles();

      // Populate Rocksniffer path if there is a default set
      const rocksnifferPath = await api.storeGet('user_data.' + userId + '.rocksniffer_path');
      if (rocksnifferPath !== null) {
        document.getElementById('rocksniffer_path').innerText = rocksnifferPath;
      }
    }

    main();
  </script>
</body>